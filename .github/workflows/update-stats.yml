name: Update Stats

on:
  schedule:
    - cron: '30 0 * * *'  # Run daily at 00:30 UTC
  workflow_dispatch:      # Allow manual trigger

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch Stats
        id: fetch-stats
        run: |
          # Setup variables
          REPO="MACULINX/TickZero"
          OUTPUT_FILE="assets/data/stats.json"
          
          # Initialize default values
          CLONES=0
          STARS=0
          
          # Get Clones (requires TRAFFIC_TOKEN or PAT with repo scope)
          # Fallback to GITHUB_TOKEN if TRAFFIC_TOKEN is not set, but it might not have scope
          TOKEN="${{ secrets.TRAFFIC_TOKEN || secrets.GITHUB_TOKEN }}"
          
          if [ -n "$TOKEN" ]; then
            CLONES_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/traffic/clones")
            
            # Extract count, defaulting to 0 if null/error
            CLONES=$(echo "$CLONES_RESPONSE" | jq '.count // 0')
          fi
          
          # Get Stars (public API)
          STARS_RESPONSE=$(curl -s "https://api.github.com/repos/$REPO")
          STARS=$(echo "$STARS_RESPONSE" | jq '.stargazers_count // 0')
          
          # Create JSON content
          # Use current date for updated_at
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Validation: Ensure they are numbers
          if ! [[ "$CLONES" =~ ^[0-9]+$ ]]; then CLONES=0; fi
          if ! [[ "$STARS" =~ ^[0-9]+$ ]]; then STARS=0; fi
          
          echo "Clones: $CLONES"
          echo "Stars: $STARS"
          
          # Write JSON
          mkdir -p $(dirname $OUTPUT_FILE)
          cat > $OUTPUT_FILE <<EOF
          {
            "clones": $CLONES,
            "stars": $STARS,
            "updated_at": "$DATE"
          }
          EOF
          
          # Check if file changed
          if git diff --quiet $OUTPUT_FILE; then
            echo "No changes to stats."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Stats updated."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.fetch-stats.outputs.changed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add assets/data/stats.json
          git commit -m "Update repository stats [skip ci]"
          git push
