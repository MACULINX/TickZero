{% extends "base.html" %}

{% block title %}Match #{{ match.id }} - CS2 Match History{% endblock %}

{% block content %}
<div class="match-detail">
    <h2>Match #{{ match.id }}</h2>
    <p class="match-date">{{ match.match_date }}</p>

    <!-- Match Info -->
    <div class="info-grid">
        <div class="info-card">
            <h3>ğŸ“¹ Video File</h3>
            <p class="file-path">{{ match.video_path }}</p>
        </div>
        <div class="info-card">
            <h3>ğŸ“„ Log File</h3>
            <p class="file-path">{{ match.log_path }}</p>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-label">Kills</div>
            <div class="stat-value">{{ match.total_kills }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Deaths</div>
            <div class="stat-value">{{ match.total_deaths or 0 }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">K/D Ratio</div>
            <div class="stat-value">
                {% if match.total_deaths and match.total_deaths > 0 %}
                {{ "%.2f"|format(match.total_kills / match.total_deaths) }}
                {% else %}
                {{ match.total_kills }}.00
                {% endif %}
            </div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Rounds</div>
            <div class="stat-value">{{ match.total_rounds }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Duration</div>
            <div class="stat-value">{{ "%.1f"|format(match.duration_seconds / 60) }} min</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Highlights</div>
            <div class="stat-value">{{ match.highlights_generated }}</div>
        </div>
    </div>

    <!-- Event Timeline -->
    <div class="section">
        <h3>âš”ï¸ Kill Timeline</h3>
        {% if events %}
        <div class="timeline">
            {% for event in events %}
            <div class="timeline-item">
                <span class="timeline-time">{{ "%.1f"|format(event.video_time) }}s</span>
                <span class="timeline-event">
                    {{ event.weapon }}
                    {% if event.headshot %}<span class="badge badge-headshot">HS</span>{% endif %}
                    (HP: {{ event.health }})
                </span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No kill events recorded for this match.</p>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="action-buttons">
        {% if not match.processed %}
        <button onclick="generateHighlights({{ match.id }})" class="btn btn-primary">
            ğŸ¬ Generate Highlights
        </button>
        {% else %}
        <button onclick="generateHighlights({{ match.id }})" class="btn">
            ğŸ”„ Regenerate Highlights
        </button>
        {% endif %}
        <button onclick="deleteMatch({{ match.id }})" class="btn btn-danger">
            ğŸ—‘ï¸ Delete Match
        </button>
        <a href="{{ url_for('match_list') }}" class="btn">â† Back to List</a>
    </div>

    <div id="message-box" class="message-box" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function generateHighlights(matchId) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'â³ Processing...';

        fetch(`/api/generate/${matchId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ min_priority: 6 })
        })
            .then(response => response.json())
            .then(data => {
                showMessage('âœ“ Highlight generation started! Check back in a few minutes.', 'success');
                setTimeout(() => location.reload(), 3000);
            })
            .catch(error => {
                showMessage('âœ— Error: ' + error, 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ¬ Generate Highlights';
            });
    }

    function deleteMatch(matchId) {
        if (!confirm('Are you sure you want to delete this match?')) return;

        fetch(`/api/delete/${matchId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                showMessage('âœ“ Match deleted', 'success');
                setTimeout(() => window.location.href = '/matches', 1500);
            })
            .catch(error => {
                showMessage('âœ— Error: ' + error, 'error');
            });
    }

    function showMessage(text, type) {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.className = 'message-box message-' + type;
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 5000);
    }
</script>
{% endblock %}